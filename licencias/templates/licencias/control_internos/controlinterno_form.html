{% extends "licencias/base.html" %}

{% block title %}{% if form.instance.pk %}Editar{% else %}Registrar{% endif %} control interno | SEGEY Licencias{% endblock %}

{% block content %}
<section class="module-shell module-shell--form">
    <div class="module-shell__header">
        <div class="module-shell__intro">
            <p class="module-shell__eyebrow" style="margin-bottom: 0.75rem; letter-spacing: 0.5px;">Asesores Técnicos Especializados  ·  Dirección de Secundarias</p>
            <div class="module-shell__headline-group">
                <h1 class="module-shell__title" style="margin: 0.5rem 0 1rem 0;">{% if form.instance.pk %}Editar{% else %}Registrar{% endif %} control interno</h1>
                <p class="module-shell__lead" style="margin-top: 1.25rem; line-height: 1.6;">Captura los datos del memorándum, vincúlalo con el centro de trabajo y da seguimiento al estatus.</p>
            </div>
        </div>
        <div class="module-shell__actions">
            <a class="btn btn--ghost btn--md" href="{% url 'licencias:controlinterno-list' %}">Regresar al listado</a>
        </div>
    </div>

    <div class="tramite-form-container">
    <form
        method="post"
        class="tramite-form"
        data-control-interno-form
        data-lookup-url="{{ cct_lookup_url }}"
        data-cct-api="{{ cct_api_url }}"
        data-cct-can-create="{{ perms.licencias.add_cctsecundaria|yesno:'true,false' }}"
        data-cct-can-edit="{{ perms.licencias.change_cctsecundaria|yesno:'true,false' }}"
        data-cct-can-delete="{{ perms.licencias.delete_cctsecundaria|yesno:'true,false' }}"
    >
        {% csrf_token %}
        {{ form.cct }}
        {% if form.non_field_errors %}
        <div class="form-alert" role="alert">
            {% for error in form.non_field_errors %}
            <p>{{ error }}</p>
            {% endfor %}
        </div>
        {% endif %}

        <div class="form-grid">
            <div class="form-field form-field--full">
                <label for="{{ form.cct_codigo.id_for_label }}">{{ form.cct_codigo.label }}</label>
                {{ form.cct_codigo }}
                <div class="cct-suggestions surface-subtle" data-cct-suggestions hidden></div>
                <datalist id="cct-options">
                    {% for cct in cct_catalogo %}
                    <option value="{{ cct.cct }}" data-nombre="{{ cct.nombre }}" data-servicio="{{ cct.servicio }}" data-asesor="{{ cct.asesor }}" data-sostenimiento="{{ cct.sostenimiento }}">{{ cct.cct }} · {{ cct.nombre }}</option>
                    {% endfor %}
                </datalist>
                {% if form.cct_codigo.help_text %}
                <span class="help-text">{{ form.cct_codigo.help_text }}</span>
                {% endif %}
                {% for error in form.cct_codigo.errors %}
                <span class="error-text">{{ error }}</span>
                {% endfor %}
                <div class="field-actions">
                    <button type="button" class="btn btn--secondary btn--sm" data-cct-action="search">Buscar</button>
                    {% if perms.licencias.add_cctsecundaria %}
                    <button type="button" class="btn btn--ghost btn--sm" data-cct-action="create">Nuevo</button>
                    {% endif %}
                    {% if perms.licencias.change_cctsecundaria %}
                    <button type="button" class="btn btn--ghost btn--sm" data-cct-action="edit">Editar</button>
                    {% endif %}
                    {% if perms.licencias.delete_cctsecundaria %}
                    <button type="button" class="btn btn--danger btn--sm" data-cct-action="delete">Eliminar</button>
                    {% endif %}
                </div>
            </div>

            {% for field in form.visible_fields %}
            {% if field.name != "cct_codigo" %}
            <div class="form-field{% if field.name == 'observaciones' or field.name == 'comentarios' %} form-field--full{% endif %}">
                <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                {{ field }}
                {% if field.name == "anio" %}
                {% with anio_value=form.anio.value|default:"" %}
                <datalist id="anio-options">
                    <option value="2025"></option>
                    <option value="2024"></option>
                    <option value="2023"></option>
                    <option value="2022"></option>
                    <option value="2021"></option>
                    <option value="2020"></option>
                </datalist>
                {% endwith %}
                {% endif %}
                {% if field.name == "estatus" %}
                <datalist id="estatus-options">
                    <option value="NO ATENDIDO"></option>
                    <option value="ATENDIDO"></option>
                    <option value="PENDIENTE POR INFORMACION"></option>
                    <option value="CONCLUIDO"></option>
                </datalist>
                <div class="field-actions" data-estatus-actions>
                    <button type="button" class="btn btn--ghost btn--sm" data-estatus-value="NO ATENDIDO">No atendido</button>
                    <button type="button" class="btn btn--ghost btn--sm" data-estatus-value="ATENDIDO">Atendido</button>
                    <button type="button" class="btn btn--ghost btn--sm" data-estatus-value="PENDIENTE POR INFORMACION">Pendiente por información</button>
                    <button type="button" class="btn btn--ghost btn--sm" data-estatus-value="CONCLUIDO">Concluido</button>
                </div>
                {% endif %}
                {% if field.name == "numero_oficio_contestacion" %}
                {% with anio_value=form.anio.value|default:"" %}
                <datalist id="oficio-options">
                    <option value="SE/SEB/DES-EESP/000/{% if anio_value %}{{ anio_value }}{% else %}{% now 'Y' %}{% endif %}"></option>
                    <option value="SE/SEB/DES-JUR/000/{% if anio_value %}{{ anio_value }}{% else %}{% now 'Y' %}{% endif %}"></option>
                </datalist>
                {% endwith %}
                <div class="field-actions" data-oficio-actions>
                    <button
                        type="button"
                        class="btn btn--ghost btn--sm"
                        data-oficio-template="SE/SEB/DES-EESP"
                    >Usar prefijo DES-EESP</button>
                    <button
                        type="button"
                        class="btn btn--ghost btn--sm"
                        data-oficio-template="SE/SEB/DES-JUR"
                    >Usar prefijo DES-JUR</button>
                </div>
                {% endif %}
                {% if field.help_text %}
                <span class="help-text">{{ field.help_text }}</span>
                {% endif %}
                {% for error in field.errors %}
                <span class="error-text">{{ error }}</span>
                {% endfor %}
            </div>
            {% endif %}
            {% endfor %}
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn--primary btn--md">Guardar control</button>
            <a class="btn btn--secondary btn--md" href="{% url 'licencias:controlinterno-list' %}">Cancelar</a>
        </div>
    </form>
    </div>

<div
    class="modal"
    id="cct-modal"
    hidden
    role="dialog"
    aria-modal="true"
>
    <div class="modal-overlay" data-modal-close></div>
    <div class="modal-dialog" role="document">
        <div class="modal-header">
            <h3 class="modal-title" data-modal-title>Registrar CCT</h3>
            <button type="button" class="modal-close" data-modal-close aria-label="Cerrar">&times;</button>
        </div>
        <div class="modal-body modal-body--stack">
            <section class="modal-section">
                <label for="cct-search">Buscar en el catálogo</label>
                <input type="search" id="cct-search" placeholder="Escribe CCT, nombre o municipio" data-cct-search>
                <p class="modal-hint" data-cct-hint>Escribe al menos un carácter para ver resultados del catálogo.</p>
                <div class="modal-results" data-cct-results></div>
            </section>
            <form id="cct-form" class="modal-form">
                <div class="modal-field">
                    <label for="cct-codigo">CCT</label>
                    <input type="text" id="cct-codigo" name="cct" required maxlength="12">
                </div>
                <div class="modal-field">
                    <label for="cct-nombre">Nombre</label>
                    <input type="text" id="cct-nombre" name="nombre" required maxlength="255">
                </div>
                <div class="modal-field">
                    <label for="cct-servicio">Modalidad</label>
                    <input type="text" id="cct-servicio" name="servicio" maxlength="255">
                </div>
                <div class="modal-field">
                    <label for="cct-sostenimiento">Sistema</label>
                    <input type="text" id="cct-sostenimiento" name="sostenimiento" maxlength="255">
                </div>
                <div class="modal-field">
                    <label for="cct-asesor">Asesor</label>
                    <input type="text" id="cct-asesor" name="asesor" maxlength="255">
                </div>
                <div class="modal-field">
                    <label for="cct-municipio">Municipio</label>
                    <input type="text" id="cct-municipio" name="municipio" maxlength="255">
                </div>
                <div class="modal-field">
                    <label for="cct-turno">Turno</label>
                    <input type="text" id="cct-turno" name="turno" maxlength="255">
                </div>
                <div class="modal-message" data-modal-message role="alert"></div>
                <div class="modal-actions">
                    <button type="submit" class="btn btn--primary btn--md" data-cct-save>Guardar</button>
                    <button type="button" class="btn btn--secondary btn--md" data-modal-close>Cancelar</button>
                </div>
            </form>
        </div>
    </div>
</div>
</section>
{% endblock %}
