{% extends "licencias/base.html" %}

{% block title %}Caso {{ caso.descripcion_breve }} | SEGEY Licencias{% endblock %}

{% block content %}
<section class="module-shell module-shell--form">
    <div class="module-shell__header">
        <div class="module-shell__intro">
            <p class="module-shell__eyebrow">Expedientes internos</p>
            <div class="module-shell__headline-group">
                <h1 class="module-shell__title">{{ caso.descripcion_breve }}</h1>
                <p class="module-shell__lead">Consulta los procesos, oficios y cambios de estatus registrados para este caso.</p>
            </div>
        </div>
        <div class="module-shell__actions">
            {% if perms.licencias.change_casointerno %}
            <a class="btn btn--primary btn--md" href="{% url 'licencias:casointerno-update' caso.pk %}">Editar caso</a>
            {% endif %}
            <a class="btn btn--ghost btn--md" href="{% url 'licencias:casointerno-list' %}">Volver al listado</a>
        </div>
    </div>

    <div class="tramite-form-container">
        <div class="tramite-form">
            <div class="data-grid">
                <div class="data-item">
                    <span class="data-label">CCT</span>
                    <span class="data-value">{{ caso.cct_id }} · {{ caso.cct_nombre }}</span>
                </div>
                <div class="data-item">
                    <span class="data-label">Sistema / Modalidad</span>
                    <span class="data-value">{{ caso.cct_sistema|default:"-" }} · {{ caso.cct_modalidad|default:"-" }}</span>
                </div>
                <div class="data-item">
                    <span class="data-label">Asesor del CCT</span>
                    <span class="data-value">{{ caso.asesor_cct|default:"-" }}</span>
                </div>
                <div class="data-item">
                    <span class="data-label">Fecha de apertura</span>
                    <span class="data-value">{{ caso.fecha_apertura|date:"d/m/Y" }}</span>
                </div>
                <div class="data-item">
                    <span class="data-label">Estatus</span>
                    <span class="data-value">
                        {% if caso.estatus %}
                        <span class="status-chip status-chip--{{ caso.estatus.nombre|slugify }}">{{ caso.estatus.nombre }}</span>
                        {% else %}
                        <span class="status-chip status-chip--default">Sin estatus</span>
                        {% endif %}
                    </span>
                </div>
                <div class="data-item">
                    <span class="data-label">Tipo inicial</span>
                    <span class="data-value">{{ caso.tipo_inicial.nombre }}</span>
                </div>
                <div class="data-item">
                    <span class="data-label">Área de origen</span>
                    <span class="data-value">{{ caso.area_origen_inicial.nombre }}</span>
                </div>
                <div class="data-item">
                    <span class="data-label">Folio inicial</span>
                    <span class="data-value">{{ caso.folio_inicial|default:"-" }}</span>
                </div>
            </div>

            {% if caso.observaciones_iniciales %}
            <section class="form-subsection">
                <h2 class="section-title">Observaciones iniciales</h2>
                <p>{{ caso.observaciones_iniciales }}</p>
            </section>
            {% endif %}
        </div>
    </div>

    <div class="module-table-card">
        <div class="module-table-card__header">
            <div>
                <h2 class="module-table-card__title">Procesos del caso</h2>
                <p class="module-table-card__meta">Ordenados cronológicamente; identifica vínculos y estatus.</p>
            </div>
            {% if perms.licencias.add_procesointerno %}
            <div class="module-table-card__actions">
                <a class="btn btn--primary btn--sm" href="{% url 'licencias:procesointerno-create' caso.pk %}">Agregar proceso</a>
            </div>
            {% endif %}
        </div>
        <table class="table table--interactive">
            <thead>
                <tr>
                    <th>Tipo</th>
                    <th>Folio</th>
                    <th>Fecha oficio</th>
                    <th>Áreas</th>
                    <th>Estatus</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for proceso in procesos %}
                <tr>
                    <td>
                        <span class="table__primary">{{ proceso.tipo_proceso.nombre }}</span>
                        {% if proceso.proceso_padre %}
                        <span class="table__secondary">Referenciado desde {{ proceso.proceso_padre.folio }}</span>
                        {% endif %}
                    </td>
                    <td>{{ proceso.folio|default:"-" }}</td>
                    <td>{{ proceso.fecha_oficio|date:"d/m/Y" }}</td>
                    <td>
                        <span class="table__primary">{{ proceso.area_origen.nombre }}</span>
                        <span class="table__secondary">→ {{ proceso.area_destino.nombre }}</span>
                    </td>
                    <td>
                        {% if proceso.estatus %}
                        <span class="status-chip status-chip--{{ proceso.estatus.nombre|slugify }}">{{ proceso.estatus.nombre }}</span>
                        {% else %}
                        <span class="status-chip status-chip--default">Sin estatus</span>
                        {% endif %}
                    </td>
                    <td class="table-actions">
                        <a class="table-actions__link" href="{% url 'licencias:procesointerno-detail' proceso.pk %}">Ver</a>
                        {% if perms.licencias.change_procesointerno %}
                        <a class="table-actions__link" href="{% url 'licencias:procesointerno-update' proceso.pk %}">Editar</a>
                        {% endif %}
                        {% if perms.licencias.delete_procesointerno %}
                        <a class="table-actions__link table-actions__link--danger" href="{% url 'licencias:procesointerno-delete' proceso.pk %}">Eliminar</a>
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" class="table__empty">Aún no se han registrado procesos para este caso.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="module-table-card">
        <div class="module-table-card__header">
            <h2 class="module-table-card__title">Historial de estatus del caso</h2>
            <p class="module-table-card__meta">Cada cambio conserva usuario y comentario.</p>
        </div>
        <table class="table">
            <thead>
                <tr>
                    <th>Fecha</th>
                    <th>Registrado por</th>
                    <th>Estatus anterior</th>
                    <th>Estatus nuevo</th>
                    <th>Comentario</th>
                </tr>
            </thead>
            <tbody>
                {% for cambio in historial_estatus %}
                <tr>
                    <td>{{ cambio.fecha_cambio|date:"d/m/Y H:i" }}</td>
                    <td>{{ cambio.usuario|default:"-" }}</td>
                    <td>{{ cambio.estatus_anterior.nombre|default:"(sin estatus)" }}</td>
                    <td>
                        <span class="status-chip status-chip--{{ cambio.estatus_nuevo.nombre|slugify }}">{{ cambio.estatus_nuevo.nombre }}</span>
                    </td>
                    <td>{{ cambio.comentario|default:"-" }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" class="table__empty">No hay cambios registrados.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</section>
{% endblock %}
