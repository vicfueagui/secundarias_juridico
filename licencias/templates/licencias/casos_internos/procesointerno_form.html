{% extends "licencias/base.html" %}

{% block title %}{% if form.instance.pk %}Editar proceso{% else %}Agregar proceso{% endif %} | SEGEY Licencias{% endblock %}

{% block content %}
<section class="module-shell module-shell--form">
    <div class="module-shell__header">
        <div class="module-shell__intro">
            <p class="module-shell__eyebrow">Caso: {{ caso.descripcion_breve }}</p>
            <div class="module-shell__headline-group">
                <h1 class="module-shell__title">
                    {% if form.instance.pk %}Editar proceso{% else %}Agregar proceso al caso{% endif %}
                </h1>
                <p class="module-shell__lead">Describe el oficio, define las áreas involucradas y vincula el proceso dentro de la cadena del caso.</p>
            </div>
        </div>
        <div class="module-shell__actions">
            <a class="btn btn--ghost btn--md" href="{% url 'licencias:casointerno-detail' caso.pk %}">Volver al caso</a>
        </div>
    </div>

    <div class="tramite-form-container">
        <form
            method="post"
            class="tramite-form"
            data-proceso-interno-form
            data-lookup-url="{{ cct_lookup_url }}"
            data-cct-api="{{ cct_api_url }}"
            data-cct-can-create="{{ perms.licencias.add_cctsecundaria|yesno:'true,false' }}"
            data-cct-can-edit="{{ perms.licencias.change_cctsecundaria|yesno:'true,false' }}"
            data-cct-can-delete="{{ perms.licencias.delete_cctsecundaria|yesno:'true,false' }}"
        >
            {% csrf_token %}
            {{ form.caso }}
            {{ form.cct }}
            {% if form.non_field_errors %}
            <div class="form-alert" role="alert">
                {% for error in form.non_field_errors %}
                <p>{{ error }}</p>
                {% endfor %}
            </div>
            {% endif %}
            <section class="form-subsection">
                <h2 class="section-title">Centro de trabajo asociado</h2>
                <div class="form-grid">
                    <div class="form-field form-field--full">
                        <label for="{{ form.cct_codigo.id_for_label }}">{{ form.cct_codigo.label }}</label>
                        {{ form.cct_codigo }}
                        <div class="cct-suggestions surface-subtle" data-cct-suggestions hidden></div>
                        <datalist id="cct-options">
                            {% for cct in cct_catalogo %}
                            <option value="{{ cct.cct }}" data-nombre="{{ cct.nombre }}" data-servicio="{{ cct.servicio }}" data-asesor="{{ cct.asesor }}" data-sostenimiento="{{ cct.sostenimiento }}">{{ cct.cct }} · {{ cct.nombre }}</option>
                            {% endfor %}
                        </datalist>
                        {% if form.cct_codigo.help_text %}
                        <span class="help-text">{{ form.cct_codigo.help_text }}</span>
                        {% endif %}
                        {% for error in form.cct_codigo.errors %}
                        <span class="error-text">{{ error }}</span>
                        {% endfor %}
                        <div class="field-actions">
                            <button type="button" class="btn btn--secondary btn--sm" data-cct-action="search">Buscar</button>
                            {% if perms.licencias.add_cctsecundaria %}
                            <button type="button" class="btn btn--ghost btn--sm" data-cct-action="create">Nuevo</button>
                            {% endif %}
                            {% if perms.licencias.change_cctsecundaria %}
                            <button type="button" class="btn btn--ghost btn--sm" data-cct-action="edit">Editar</button>
                            {% endif %}
                            {% if perms.licencias.delete_cctsecundaria %}
                            <button type="button" class="btn btn--danger btn--sm" data-cct-action="delete">Eliminar</button>
                            {% endif %}
                        </div>
                    </div>
                    <div class="form-field">
                        <label for="{{ form.cct_nombre.id_for_label }}">{{ form.cct_nombre.label }}</label>
                        {{ form.cct_nombre }}
                    </div>
                    <div class="form-field">
                        <label for="{{ form.cct_modalidad.id_for_label }}">{{ form.cct_modalidad.label }}</label>
                        {{ form.cct_modalidad }}
                    </div>
                    <div class="form-field">
                        <label for="{{ form.cct_sistema.id_for_label }}">{{ form.cct_sistema.label }}</label>
                        {{ form.cct_sistema }}
                    </div>
                    <div class="form-field">
                        <label for="{{ form.asesor_cct.id_for_label }}">{{ form.asesor_cct.label }}</label>
                        {{ form.asesor_cct }}
                    </div>
                </div>
            </section>

            <section class="form-subsection">
                <h2 class="section-title">Información del proceso</h2>
                <div class="form-grid">
                    <div class="form-field">
                        <label for="{{ form.tipo_proceso.id_for_label }}">{{ form.tipo_proceso.label }}</label>
                        {{ form.tipo_proceso }}
                    </div>
                    <div class="form-field">
                        <label for="{{ form.folio.id_for_label }}">{{ form.folio.label }}</label>
                        {{ form.folio }}
                    </div>
                    <div class="form-field">
                        <label for="{{ form.fecha_oficio.id_for_label }}">{{ form.fecha_oficio.label }}</label>
                        {{ form.fecha_oficio }}
                    </div>
                    <div class="form-field">
                        <label for="{{ form.area_origen.id_for_label }}">{{ form.area_origen.label }}</label>
                        {{ form.area_origen }}
                    </div>
                    <div class="form-field">
                        <label for="{{ form.area_destino.id_for_label }}">{{ form.area_destino.label }}</label>
                        {{ form.area_destino }}
                    </div>
                    <div class="form-field">
                        <label for="{{ form.asesor_responsable.id_for_label }}">{{ form.asesor_responsable.label }}</label>
                        {{ form.asesor_responsable }}
                    </div>
                    <div class="form-field">
                        <label for="{{ form.proceso_padre.id_for_label }}">{{ form.proceso_padre.label }}</label>
                        {{ form.proceso_padre }}
                    </div>
                    <div class="form-field">
                        <label for="{{ form.estatus.id_for_label }}">{{ form.estatus.label }}</label>
                        {{ form.estatus }}
                    </div>
                    <div class="form-field form-field--full">
                        <label for="{{ form.asunto.id_for_label }}">{{ form.asunto.label }}</label>
                        {{ form.asunto }}
                    </div>
                    <div class="form-field form-field--full">
                        <label for="{{ form.observaciones.id_for_label }}">{{ form.observaciones.label }}</label>
                        {{ form.observaciones }}
                    </div>
                </div>
            </section>

            <div class="form-actions">
                <button type="submit" class="btn btn--primary btn--md">Guardar proceso</button>
                <a class="btn btn--secondary btn--md" href="{% url 'licencias:casointerno-detail' caso.pk %}">Cancelar</a>
            </div>
        </form>
    </div>

    <div class="modal" id="cct-modal" hidden role="dialog" aria-modal="true">
        <div class="modal-overlay" data-modal-close></div>
        <div class="modal-dialog" role="document">
            <div class="modal-header">
                <h3 class="modal-title" data-modal-title>Registrar CCT</h3>
                <button type="button" class="modal-close" data-modal-close aria-label="Cerrar">&times;</button>
            </div>
            <div class="modal-body modal-body--stack">
                <section class="modal-section">
                    <label for="cct-search">Buscar en el catálogo</label>
                    <input type="search" id="cct-search" placeholder="Escribe CCT, nombre o municipio" data-cct-search>
                    <p class="modal-hint" data-cct-hint>Escribe al menos un carácter para ver resultados del catálogo.</p>
                    <div class="modal-results" data-cct-results></div>
                </section>
                <form id="cct-form" class="modal-form">
                    <div class="modal-field">
                        <label for="cct-codigo">CCT</label>
                        <input type="text" id="cct-codigo" name="cct" required maxlength="12">
                    </div>
                    <div class="modal-field">
                        <label for="cct-nombre">Nombre</label>
                        <input type="text" id="cct-nombre" name="nombre" required maxlength="255">
                    </div>
                    <div class="modal-field">
                        <label for="cct-servicio">Modalidad</label>
                        <input type="text" id="cct-servicio" name="servicio" maxlength="255">
                    </div>
                    <div class="modal-field">
                        <label for="cct-sostenimiento">Sistema</label>
                        <input type="text" id="cct-sostenimiento" name="sostenimiento" maxlength="255">
                    </div>
                    <div class="modal-field">
                        <label for="cct-asesor">Asesor</label>
                        <input type="text" id="cct-asesor" name="asesor" maxlength="255">
                    </div>
                    <div class="modal-field">
                        <label for="cct-municipio">Municipio</label>
                        <input type="text" id="cct-municipio" name="municipio" maxlength="255">
                    </div>
                    <div class="modal-field">
                        <label for="cct-turno">Turno</label>
                        <input type="text" id="cct-turno" name="turno" maxlength="255">
                    </div>
                    <div class="modal-message" data-modal-message role="alert"></div>
                    <div class="modal-actions">
                        <button type="submit" class="btn btn--primary btn--md" data-cct-save>Guardar</button>
                        <button type="button" class="btn btn--secondary btn--md" data-modal-close>Cancelar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</section>
{% endblock %}
