{% extends "tramites/base.html" %}

{% block title %}{{ form.instance.pk|yesno:"Editar trámite del caso,Agregar trámite al caso" }} | SEGEY Trámites{% endblock %}

{% block content %}
<section class="module-shell module-shell--form">
    <div class="module-shell__header">
        <div class="module-shell__intro">
            <p class="module-shell__eyebrow">Trámites asociados</p>
            <div class="module-shell__headline-group">
                <h1 class="module-shell__title">
                    {% if form.instance.pk %}Editar trámite del caso{% else %}Nuevo trámite para el caso{% endif %}
                </h1>
                <p class="module-shell__lead">Captura o actualiza la información del trámite y su estatus.</p>
            </div>
        </div>
        <div class="module-shell__actions">
            <a class="btn btn--ghost btn--md" href="{% url 'tramites:casointerno-detail' caso.pk %}">Volver al caso</a>
            {% if form.instance.pk %}
            <a class="btn btn--ghost btn--md" href="{% url 'tramites:tramite-caso-detail' caso.pk form.instance.pk %}">Ver trámite</a>
            {% endif %}
        </div>
    </div>

    <form method="post" class="tramite-form" data-tramite-caso-form>
        {% csrf_token %}
        {% if form.non_field_errors %}
        <div class="alert alert--danger">
            {{ form.non_field_errors }}
        </div>
        {% endif %}

        <div class="form-subsection">
            <h2 class="section-title">Datos del trámite</h2>
            <div class="form-grid">
                <div class="form-field">
                    <label for="{{ form.tipo.id_for_label }}">{{ form.tipo.label }}</label>
                    {{ form.tipo }}
                    <div class="field-actions">
                        <button type="button" class="btn btn--ghost btn--sm" data-crud-open="tipo-proceso" data-crud-target="{{ form.tipo.id_for_label }}">Agregar tipo</button>
                        <button type="button" class="btn btn--ghost btn--sm" data-crud-edit="tipo-proceso" data-crud-target="{{ form.tipo.id_for_label }}">Editar seleccionado</button>
                        <button type="button" class="btn btn--danger btn--sm" data-crud-delete="tipo-proceso" data-crud-target="{{ form.tipo.id_for_label }}">Eliminar seleccionado</button>
                    </div>
                </div>
                <div class="form-field">
                    <label for="{{ form.fecha.id_for_label }}">{{ form.fecha.label }}</label>
                    {{ form.fecha }}
                </div>
                <div class="form-field">
                    <label for="{{ form.numero_oficio.id_for_label }}">{{ form.numero_oficio.label }}</label>
                    {{ form.numero_oficio }}
                    <p class="help-text">Selecciona un prefijo sugerido o escribe el número completo.</p>
                </div>
                <div class="form-field">
                    <label for="prefijo-oficio-select">Prefijos sugeridos</label>
                    <select id="prefijo-oficio-select" data-prefijo-oficio-select>
                        <option value="">Selecciona un prefijo para usarlo o editarlo</option>
                        {% for prefijo in prefijos_oficio %}
                        <option value="{{ prefijo.id }}">{{ prefijo.nombre }}</option>
                        {% endfor %}
                    </select>
                    <div class="field-actions">
                        <button type="button" class="btn btn--ghost btn--sm" data-prefijo-oficio-modal-open>Nuevo prefijo</button>
                        <button type="button" class="btn btn--ghost btn--sm" data-prefijo-oficio-modal-edit>Editar seleccionado</button>
                        <button type="button" class="btn btn--danger btn--sm" data-prefijo-oficio-modal-delete>Eliminar seleccionado</button>
                    </div>
                    <p class="help-text">Al seleccionar un prefijo se colocará en el campo de número de oficio y podrás modificarlo.</p>
                    <datalist id="prefijo-oficio-options">
                        {% for prefijo in prefijos_oficio %}
                        <option value="{{ prefijo.nombre }}"></option>
                        {% endfor %}
                    </datalist>
                </div>
                <div class="form-field">
                    <label for="{{ form.estatus.id_for_label }}">{{ form.estatus.label }}</label>
                    {{ form.estatus }}
                    <div class="field-actions">
                        <button type="button" class="btn btn--ghost btn--sm" data-crud-open="estatus-tramite" data-crud-target="{{ form.estatus.id_for_label }}">Agregar estatus</button>
                        <button type="button" class="btn btn--ghost btn--sm" data-crud-edit="estatus-tramite" data-crud-target="{{ form.estatus.id_for_label }}">Editar seleccionado</button>
                        <button type="button" class="btn btn--danger btn--sm" data-crud-delete="estatus-tramite" data-crud-target="{{ form.estatus.id_for_label }}">Eliminar seleccionado</button>
                    </div>
                </div>
                <div class="form-field form-field--full">
                    <label for="comentario-estatus">{{ "Comentario de estatus (opcional)" }}</label>
                    <textarea id="comentario-estatus" name="comentario_estatus" rows="2" class="form-input" placeholder="Ej. Se recibe documentación o se turna a otra área."></textarea>
                </div>
                <div class="form-field form-field--full">
                    <label for="{{ form.asunto.id_for_label }}">{{ form.asunto.label }}</label>
                    {{ form.asunto }}
                </div>
                <div class="form-field">
                    <label for="{{ form.solicitante.id_for_label }}">{{ form.solicitante.label }}</label>
                    {{ form.solicitante }}
                    <div class="field-actions">
                        <button type="button" class="btn btn--ghost btn--sm" data-crud-open="solicitante" data-crud-target="{{ form.solicitante.id_for_label }}">Nuevo</button>
                        <button type="button" class="btn btn--ghost btn--sm" data-crud-edit="solicitante" data-crud-target="{{ form.solicitante.id_for_label }}">Editar seleccionado</button>
                        <button type="button" class="btn btn--danger btn--sm" data-crud-delete="solicitante" data-crud-target="{{ form.solicitante.id_for_label }}">Eliminar seleccionado</button>
                    </div>
                </div>
                <div class="form-field">
                    <label for="{{ form.dirigido_a.id_for_label }}">{{ form.dirigido_a.label }}</label>
                    {{ form.dirigido_a }}
                    <div class="field-actions">
                        <button type="button" class="btn btn--ghost btn--sm" data-crud-open="destinatario" data-crud-target="{{ form.dirigido_a.id_for_label }}">Nuevo</button>
                        <button type="button" class="btn btn--ghost btn--sm" data-crud-edit="destinatario" data-crud-target="{{ form.dirigido_a.id_for_label }}">Editar seleccionado</button>
                        <button type="button" class="btn btn--danger btn--sm" data-crud-delete="destinatario" data-crud-target="{{ form.dirigido_a.id_for_label }}">Eliminar seleccionado</button>
                    </div>
                </div>
                <div class="form-field">
                    <label for="{{ form.tipo_violencia.id_for_label }}">{{ form.tipo_violencia.label }}</label>
                    {{ form.tipo_violencia }}
                    <div class="field-actions">
                        <button type="button" class="btn btn--ghost btn--sm" data-crud-open="tipo-violencia" data-crud-target="{{ form.tipo_violencia.id_for_label }}">Nuevo</button>
                        <button type="button" class="btn btn--ghost btn--sm" data-crud-edit="tipo-violencia" data-crud-target="{{ form.tipo_violencia.id_for_label }}">Editar seleccionado</button>
                        <button type="button" class="btn btn--danger btn--sm" data-crud-delete="tipo-violencia" data-crud-target="{{ form.tipo_violencia.id_for_label }}">Eliminar seleccionado</button>
                    </div>
                </div>
                <div class="form-field form-field--full">
                    <label for="{{ form.observaciones.id_for_label }}">{{ form.observaciones.label }}</label>
                    {{ form.observaciones }}
                </div>
            </div>
        </div>

        <div class="form-subsection">
            <h2 class="section-title">Participantes</h2>
            <div class="form-grid">
                <div class="form-field">
                    <label for="{{ form.generador_nombre.id_for_label }}">{{ form.generador_nombre.label }}</label>
                    {{ form.generador_nombre }}
                </div>
                <div class="form-field">
                    <label for="{{ form.generador_iniciales.id_for_label }}">{{ form.generador_iniciales.label }}</label>
                    {{ form.generador_iniciales }}
                </div>
                <div class="form-field">
                    <label for="{{ form.generador_sexo.id_for_label }}">{{ form.generador_sexo.label }}</label>
                    {{ form.generador_sexo }}
                </div>
                <div class="form-field">
                    <label for="{{ form.receptor_nombre.id_for_label }}">{{ form.receptor_nombre.label }}</label>
                    {{ form.receptor_nombre }}
                </div>
                <div class="form-field">
                    <label for="{{ form.receptor_iniciales.id_for_label }}">{{ form.receptor_iniciales.label }}</label>
                    {{ form.receptor_iniciales }}
                </div>
                <div class="form-field">
                    <label for="{{ form.receptor_sexo.id_for_label }}">{{ form.receptor_sexo.label }}</label>
                    {{ form.receptor_sexo }}
                </div>
            </div>
            <div class="form-field form-field--full">
                <div class="field-actions">
                    <span class="section-subtitle">Receptores adicionales</span>
                    <button type="button" class="btn btn--ghost btn--sm" data-receptor-adicional-add>Agregar receptor</button>
                </div>
                <table class="table table--interactive">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Iniciales NNA</th>
                            <th>Sexo</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody data-receptores-rows>
                        <tr class="table__empty-row"><td colspan="4" class="table__empty">No hay receptores adicionales.</td></tr>
                    </tbody>
                </table>
                {{ form.receptores_adicionales }}
            </div>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn--primary btn--md">
                {% if form.instance.pk %}Actualizar trámite{% else %}Guardar trámite{% endif %}
            </button>
            <a class="btn btn--ghost btn--md" href="{% url 'tramites:casointerno-detail' caso.pk %}">Cancelar</a>
        </div>

        <datalist id="prefijo-oficio-options">
            {% for prefijo in prefijos_oficio %}
            <option value="{{ prefijo.nombre }}"></option>
            {% endfor %}
        </datalist>
    </form>
</section>

<div class="modal" id="receptor-adicional-modal" hidden role="dialog" aria-modal="true">
    <div class="modal-overlay" data-modal-close></div>
    <div class="modal-dialog" role="document">
        <div class="modal-header">
            <h3 class="modal-title" data-modal-title>Agregar receptor adicional</h3>
            <button type="button" class="modal-close" data-modal-close aria-label="Cerrar">&times;</button>
        </div>
        <div class="modal-body">
            <form id="receptor-adicional-form" class="modal-form">
                <fieldset id="receptor-adicional-fields">
                    <div class="modal-field">
                        <label for="receptor-adicional-nombre">Nombre</label>
                        <input type="text" id="receptor-adicional-nombre" name="nombre" maxlength="255">
                    </div>
                    <div class="modal-field">
                        <label for="receptor-adicional-iniciales">Iniciales del NNA (Ej. A.B.C.D.)</label>
                        <input type="text" id="receptor-adicional-iniciales" name="iniciales" maxlength="50" placeholder="Ej. A.B.C.D.">
                    </div>
                    <div class="modal-field">
                        <label for="receptor-adicional-sexo">Sexo del NNA</label>
                        <select id="receptor-adicional-sexo" name="sexo">
                            <option value="">---------</option>
                            <option value="M">Mujer</option>
                            <option value="H">Hombre</option>
                        </select>
                    </div>
                </fieldset>
                <div class="modal-message" data-modal-message role="alert"></div>
                <div class="modal-actions">
                    <button type="submit" class="btn btn--primary btn--md" data-receptor-adicional-save>Guardar</button>
                    <button type="button" class="btn btn--secondary btn--md" data-modal-close>Cancelar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal para CRUD de Prefijos de Oficio -->
<div class="modal" id="prefijo-oficio-modal" hidden role="dialog" aria-modal="true">
    <div class="modal-overlay" data-modal-close></div>
    <div class="modal-dialog" role="document">
        <div class="modal-header">
            <h3 class="modal-title" data-modal-title>Agregar prefijo de oficio</h3>
            <button type="button" class="modal-close" data-modal-close aria-label="Cerrar">&times;</button>
        </div>
        <div class="modal-body">
            <form id="prefijo-oficio-form" class="modal-form">
                <fieldset id="prefijo-oficio-fields">
                    <div class="modal-field">
                        <label for="prefijo-oficio-nombre">Prefijo</label>
                        <input type="text" id="prefijo-oficio-nombre" name="nombre" required maxlength="255" placeholder="Ej. SE/SEB/DES-EESP">
                    </div>
                    <div class="modal-field">
                        <label for="prefijo-oficio-descripcion">Descripción (opcional)</label>
                        <textarea id="prefijo-oficio-descripcion" name="descripcion" maxlength="500" rows="3" placeholder="Notas internas para identificar el prefijo."></textarea>
                    </div>
                </fieldset>
                <div class="modal-message" data-modal-message role="alert"></div>
                <div class="modal-actions">
                    <button type="submit" class="btn btn--primary btn--md" data-prefijo-oficio-save>Guardar</button>
                    <button type="button" class="btn btn--secondary btn--md" data-modal-close>Cancelar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modales de catálogos para CRUD -->
<div class="modal" id="tipo-proceso-modal" hidden role="dialog" aria-modal="true">
    <div class="modal-overlay" data-modal-close></div>
    <div class="modal-dialog" role="document">
        <div class="modal-header">
            <h3 class="modal-title" data-modal-title>Agregar tipo de trámite</h3>
            <button type="button" class="modal-close" data-modal-close aria-label="Cerrar">&times;</button>
        </div>
        <div class="modal-body">
            <form id="tipo-proceso-form" class="modal-form">
                <fieldset id="tipo-proceso-fields">
                    <div class="modal-field">
                        <label for="tipo-proceso-nombre">Nombre del tipo</label>
                        <input type="text" id="tipo-proceso-nombre" name="nombre" required maxlength="255">
                    </div>
                    <div class="modal-field">
                        <label for="tipo-proceso-descripcion">Descripción (opcional)</label>
                        <textarea id="tipo-proceso-descripcion" name="descripcion" maxlength="500" rows="3"></textarea>
                    </div>
                    <div class="modal-field">
                        <label>
                            <input type="checkbox" id="tipo-proceso-es-documento" name="es_documento">
                            Requiere documentos adicionales
                        </label>
                    </div>
                </fieldset>
                <div class="modal-message" data-modal-message role="alert"></div>
                <div class="modal-actions">
                    <button type="submit" class="btn btn--primary btn--md" data-tipo-proceso-save>Guardar</button>
                    <button type="button" class="btn btn--secondary btn--md" data-modal-close>Cancelar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal" id="tipo-violencia-modal" hidden role="dialog" aria-modal="true">
    <div class="modal-overlay" data-modal-close></div>
    <div class="modal-dialog" role="document">
        <div class="modal-header">
            <h3 class="modal-title" data-modal-title>Agregar tipo de violencia</h3>
            <button type="button" class="modal-close" data-modal-close aria-label="Cerrar">&times;</button>
        </div>
        <div class="modal-body">
            <form id="tipo-violencia-form" class="modal-form">
                <fieldset id="tipo-violencia-fields">
                    <div class="modal-field">
                        <label for="tipo-violencia-nombre">Nombre del tipo</label>
                        <input type="text" id="tipo-violencia-nombre" name="nombre" required maxlength="255">
                    </div>
                    <div class="modal-field">
                        <label for="tipo-violencia-descripcion">Descripción (opcional)</label>
                        <textarea id="tipo-violencia-descripcion" name="descripcion" maxlength="500" rows="3"></textarea>
                    </div>
                </fieldset>
                <div class="modal-message" data-modal-message role="alert"></div>
                <div class="modal-actions">
                    <button type="submit" class="btn btn--primary btn--md" data-tipo-violencia-save>Guardar</button>
                    <button type="button" class="btn btn--secondary btn--md" data-modal-close>Cancelar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal" id="solicitante-modal" hidden role="dialog" aria-modal="true">
    <div class="modal-overlay" data-modal-close></div>
    <div class="modal-dialog" role="document">
        <div class="modal-header">
            <h3 class="modal-title" data-modal-title>Agregar solicitante</h3>
            <button type="button" class="modal-close" data-modal-close aria-label="Cerrar">&times;</button>
        </div>
        <div class="modal-body">
            <form id="solicitante-form" class="modal-form">
                <fieldset id="solicitante-fields">
                    <div class="modal-field">
                        <label for="solicitante-nombre">Nombre</label>
                        <input type="text" id="solicitante-nombre" name="nombre" required maxlength="255">
                    </div>
                    <div class="modal-field">
                        <label for="solicitante-descripcion">Descripción (opcional)</label>
                        <textarea id="solicitante-descripcion" name="descripcion" maxlength="500" rows="3"></textarea>
                    </div>
                </fieldset>
                <div class="modal-message" data-modal-message role="alert"></div>
                <div class="modal-actions">
                    <button type="submit" class="btn btn--primary btn--md" data-solicitante-save>Guardar</button>
                    <button type="button" class="btn btn--secondary btn--md" data-modal-close>Cancelar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal" id="destinatario-modal" hidden role="dialog" aria-modal="true">
    <div class="modal-overlay" data-modal-close></div>
    <div class="modal-dialog" role="document">
        <div class="modal-header">
            <h3 class="modal-title" data-modal-title>Agregar destinatario</h3>
            <button type="button" class="modal-close" data-modal-close aria-label="Cerrar">&times;</button>
        </div>
        <div class="modal-body">
            <form id="destinatario-form" class="modal-form">
                <fieldset id="destinatario-fields">
                    <div class="modal-field">
                        <label for="destinatario-nombre">Nombre</label>
                        <input type="text" id="destinatario-nombre" name="nombre" required maxlength="255">
                    </div>
                    <div class="modal-field">
                        <label for="destinatario-descripcion">Descripción (opcional)</label>
                        <textarea id="destinatario-descripcion" name="descripcion" maxlength="500" rows="3"></textarea>
                    </div>
                </fieldset>
                <div class="modal-message" data-modal-message role="alert"></div>
                <div class="modal-actions">
                    <button type="submit" class="btn btn--primary btn--md" data-destinatario-save>Guardar</button>
                    <button type="button" class="btn btn--secondary btn--md" data-modal-close>Cancelar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal" id="estatus-tramite-modal" hidden role="dialog" aria-modal="true">
    <div class="modal-overlay" data-modal-close></div>
    <div class="modal-dialog" role="document">
        <div class="modal-header">
            <h3 class="modal-title" data-modal-title>Agregar estatus de trámite</h3>
            <button type="button" class="modal-close" data-modal-close aria-label="Cerrar">&times;</button>
        </div>
        <div class="modal-body">
            <form id="estatus-tramite-form" class="modal-form">
                <fieldset id="estatus-tramite-fields">
                    <div class="modal-field">
                        <label for="estatus-tramite-nombre">Nombre del estatus</label>
                        <input type="text" id="estatus-tramite-nombre" name="nombre" required maxlength="255">
                    </div>
                    <div class="modal-field">
                        <label for="estatus-tramite-descripcion">Descripción (opcional)</label>
                        <textarea id="estatus-tramite-descripcion" name="descripcion" maxlength="500" rows="3"></textarea>
                    </div>
                    <div class="modal-field">
                        <label for="estatus-tramite-orden">Orden</label>
                        <input type="number" id="estatus-tramite-orden" name="orden" min="1" step="1" value="1">
                    </div>
                </fieldset>
                <div class="modal-message" data-modal-message role="alert"></div>
                <div class="modal-actions">
                    <button type="submit" class="btn btn--primary btn--md" data-estatus-tramite-save>Guardar</button>
                    <button type="button" class="btn btn--secondary btn--md" data-modal-close>Cancelar</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}
